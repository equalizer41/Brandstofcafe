@using projectweb.Components.Flow
@using projectweb.Repositories
@inject BestellingStateService BestelState
@inject TafelRepository TafelRepo
@implements IDisposable

<p>DEBUG: Loaded sectie ID = @BestelState.GeselecteerdeSectie?.Id</p>
<p>DEBUG: Aantal tafels = @Tafels?.Count</p>

<h3>Selecteer een tafel</h3>

<!-- Toont alle tafels in de tabel Tafels op basis van SectieID-->
<div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
    @foreach (var t in Tafels)
    {
        <div class="col">
                <div class="card-body">
                <h5 class="card-title">Tafel @t.Naam (ID: @t.Id)</h5>
                <button class="btn btn-primary" @onclick="() => SelecteerTafel(t.Id)">

                    @(BestelState.GeselecteerdeTafel?.Id == t.Id ? "Sluit overzicht" : "Toon overzicht")
                </button>
                </div>
        </div>
    }
</div>


@code {
    [Parameter] public EventCallback<int> TafelIsGeselecteerd { get; set; }
    // Maakt een nieuwe lijst om Tafels in op te slaan
    private List<Tafel> Tafels { get; set; } = new();

    // Plaatst alle Tafels waarbij de sectieID gelijk is met de sectieid uit de bestelstate
    protected override void OnInitialized()
    {
        Console.WriteLine("[DEBUG] TafelLijst - OnInitialized aangeroepen");
        Console.WriteLine($"[DEBUG] TafelLijst - GeselecteerdeSectieid heeft waarde: {BestelState.GeselecteerdeSectie?.Id}");
        Tafels = TafelRepo.GetAll()
                          .Where(t => t.SectieId == BestelState.GeselecteerdeSectie?.Id)
                          .ToList();
        Console.WriteLine($"[DEBUG] Tafels geladen: {Tafels.Count}");

        // Roept HerlaadTafels aan zodat de tafels tabel weer wordt vernieuwd als een nieuwe sectie wordt gekozen
        BestelState.OnChange += HerlaadTafel;
    }

    // Herlaad alle Tafels waarbij de sectieID gelijk is met de sectieid uit de bestelstate

    private void HerlaadTafel()
    {
        Tafels = TafelRepo.GetAll()
                        .Where(t => t.SectieId == BestelState.GeselecteerdeSectie?.Id)
                        .ToList();
       
        BestelState.OnChange += StateHasChanged;

    }

    // Geeft de geselecteerde tafel door aan de bestelstate -> daarna kan tafelbesteloverzicht worden geladen
    private void SelecteerTafel(int id)
    {
        var tafel = Tafels.FirstOrDefault(t => t.Id == id);

        // Toggle : deselecteer als hij al actief is

        if (BestelState.GeselecteerdeTafel?.Id == tafel?.Id)
        {
            BestelState.SelecteerTafel(null); // Deselecteer 
        }
        else
        {
            BestelState.SelecteerTafel(tafel);

        }
        StateHasChanged();
    }

    public void Dispose()
    {
        BestelState.OnChange -= HerlaadTafel;
    }
}
